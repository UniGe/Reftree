var alysso=alysso||{},plani3dmodel=plani3dmodel||{},alyssoInputDate=getUrlVars.dataRif;String.prototype.startsWithIgnorCase=function(a){return 0===this.toUpperCase().indexOf(a.toUpperCase())};Set.prototype.union=function(a){var m=new Set(this);a=a.values();for(var d=null;d=a.next().value;)m.add(d);return m};Set.prototype.intersection=function(a){var m=new Set;a=a.values();for(var d=null;d=a.next().value;)this.has(d)&&m.add(d);return m};
Set.prototype.difference=function(a){var m=new Set(this);a=a.values();for(var d=null;d=a.next().value;)m["delete"](d);return m};String.prototype.replaceAll=function(a,m){return this.split(a).join(m)};var alyLatinMap={"Á":"A","À":"A","É":"E","È":"E","Í":"I","Ì":"I","Ó":"O","Ờ":"O","Ú":"U","Ù":"U","á":"a","à":"a","é":"e","è":"e","í":"i","ì":"i","ó":"o","ờ":"o","ú":"u","ù":"u"};String.prototype.alyLatinize=function(){return this.replace(/[^A-Za-z0-9\[\] ]/g,function(a){return alyLatinMap[a]||a})};
plani3dmodel.Config=function(a){this.server=a.server;this.maps=a.maps;this.viewer;this.strJsonDataType="json";this.strApplicationJson="application/json";this.init=function(){this.prepareBlockUIPanel()};this.prepareBlockUIPanel=function(){$.blockUI.defaults={message:'\x3cimg src\x3d"./imgs/loading.gif" style\x3d"height: 20px; vertical-align: middle; padding-right: 8px;"/\x3e\x3cspan style\x3d"vertical-align: middle;"\x3eAttendere...\x3c/span\x3e',theme:!1,css:{margin:0,width:"20%",top:"40%",left:"40%",
textAlign:"center",cursor:"defautl",border:"none",padding:"15px",backgroundColor:"#000","border-radius":"10px","-webkit-border-radius":"10px","-moz-border-radius":"10px",opacity:.5,color:"#fff"},themedCSS:{width:"30%",top:"40%",left:"35%"},overlayCSS:{backgroundColor:"#000",opacity:.6,cursor:"defautl"},cursorReset:"default",growlCSS:{width:"350px",top:"10px",left:"",right:"10px",padding:"5px",opacity:.6,color:"#fff",backgroundColor:"#000",cursor:null,border:"none","border-radius":"10px","-webkit-border-radius":"10px",
"-moz-border-radius":"10px"},centerX:!0,centerY:!0,allowBodyStretch:!0,bindEvents:!0,constrainTabKey:!0,fadeIn:300,fadeOut:300,timeout:0,showOverlay:!0,quirksmodeOffsetHack:4,blockMsgClass:"p3d-blockMsg",ignoreIfBlocked:!1}}};
alysso.Utils=function(a){this.objConfig=a;this.isNumeric=function(a){return!isNaN(a)};this.getTodayFormatted=function(){var a=new Date,d=a.getDate(),d=10>d?"0"+d:d,k=a.getMonth()+1,k=10>k?"0"+k:k;return a.getFullYear()+"-"+k+"-"+d};this.getDateInWFSFormat=function(a){return a+this.objConfig.validityDateTimeSection};this.storeGeneralCallTimeAndReturnIt=function(){var a=(new Date).getTime();return this.objConfig.lastIdentifyTime=a};this.capitalizeFirstCharacter=function(a){if("undefined"!=typeof a&&
0<a.length)return a.charAt(0).toUpperCase()+a.slice(1)};this.setInternalNulls=function(a){a=JSON.stringify(a,function(a,m){return null==m||"null"==m?"":"string"===$.type(m)?m.replaceAll('"',"'"):m});return JSON.parse(a)};this.getObjFromArrayByPropValue=function(a,d,k){for(var e in a)if("undefined"!=typeof a[e][d]&&a[e][d]==k)return a[e];return{}};this.addGeometryFeatureToHighlightLayerVector=function(a,d,k){if("Point"==a.getType()){var e=new ol.Feature({geometry:a});d.getSource().addFeature(e)}else for(e in a=
a.getPolygons(),a)k=new ol.Feature({geometry:a[e]}),d.getSource().addFeature(k)};this.dehighlightSelection=function(a){a.getSource().clear()};this.isContainedInArray=function(a,d){for(var k in d)if(d[k]==a)return!0;return!1};this.getPropValueFromArray=function(a,d,k,e){var r="",q;for(q in a)if("undefined"!=typeof a[q][d]&&a[q][d]==k&&"undefined"!=typeof a[q][e]){r=a[q][e];break}return r};this.getWebappUrl=function(a,d){return a+"://"+d};this.getServerUrl=function(a,d,k){return this.getWebappUrl(a,
d)+"/"+k};this.resizeBodyHeight=function(){$("body").css("height",window.innerHeight+"px")};this.resizeHeighDiv=function(a,d,k){var e=0;k&&(e=k.height());newHeight=parseInt(""+e*d/100);$(a).height(newHeight)};this.tableToJson=function(a){var d={};a=a.substring(a.indexOf("\x3ctd\x3e")+4,a.length);a=a.substring(0,a.lastIndexOf("\x3c/td\x3e"));a=a.split("\x3c/td\x3e\x3c/tr\x3e\x3ctr\x3e\x3ctd\x3e");for(var k in a){var e=a[k].split("\x3c/td\x3e\x3ctd\x3e");d[e[0]]=e[1]}return d}};
plani3dmodel.Plani3D=function(a){var m=!1;"undefined"==typeof a.imgpath&&(a.imgpath="");"undefined"==typeof a.protocol&&(a.protocol="http");"undefined"==typeof a.webapp&&(a.webapp="plani3d-viewer");"undefined"==typeof a.maps&&(a.maps="default");"undefined"==typeof a.target&&(a.target="p3d-model");var d=new plani3dmodel.Config({server:a.server}),k=new alysso.Utils(d),e=Cesium.createOpenStreetMapImageryProvider({url:"https://a.tile.openstreetmap.org/"});new Cesium.ArcGisMapServerImageryProvider({url:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"});
var r=[],q=[],s,z=!1;this.init=function(){return new Promise(function(n,c){try{d.viewer=new Cesium.Viewer(a.target,{imageryProvider:e,baseLayerPicker:!1,navigationHelpButton:!1,animation:!1,geocoder:!1,homeButton:!1,sceneModePicker:!1,timeline:!1,targetFrameRate:5}),$("#"+a.target+" .cesium-viewer").append($("\x3cdiv\x3e").attr("class","progress progress-striped active").attr("id","myprogress")),$("#"+a.target+" #myprogress").append($("\x3cdiv\x3e").attr("class","progress-bar progress-bar-striped").attr("id",
"myprogressbar").attr("role","progressbar").attr("style","width:100%")),n()}catch(u){c(u)}m=!0;console.log("3d init completed");t(!1)})};this.loadGeojson=function(a,c,u,b,k,f,g){if(m){t(!0);var h={sub:{display:!1},nome_piano:{display:!0,label:"Piano"},tipo_vano:{display:!0,label:"Vano"},area_vano:{display:!0,label:"Superficie"},area_uiu:{display:!0,label:"Superficie UIU"},comune:{display:!1,label:"Comune"},foglio:{display:!1,label:"Foglio"},mappale:{display:!1,label:"Mappale"},assetid:{display:!0,
label:"AssetID"},codice_asset:{display:!0,label:"Codice Asset"},descrizione:{display:!0,label:"Subalterno"},valori_tema:{display:!1}};Cesium.GeoJsonDataSource.load(c).then(function(c){var m=y(k);c.name=a;c.data=g;for(var p=c.entities.values,e=0;e<p.length;e++){p[e].polygon.extrudedHeight=b;p[e].polygon.height=u;p[e].polygon.material=m.fill;p[e].polygon.outlineColor=m.outline;for(var r in g)p[e].properties.addProperty(r,g[r]);var q="\x3ctable\x3e\x3ctbody\x3e",s=p[e].properties.propertyNames,v;for(v in s)"undefined"!=
typeof h[s[v]]&&1==h[s[v]].display&&(q+="\x3ctr\x3e\x3ctd\x3e"+h[s[v]].label+"\x3c/td\x3e\x3ctd\x3e"+p[e].properties[s[v]]._value+"\x3c/td\x3e\x3c/tr\x3e");q+="\x3c/tbody\x3e\x3c/table\x3e";p[e].description=q}d.viewer.dataSources.add(c);f&&d.viewer.zoomTo(c);t(!1)})}else{var p=this;setTimeout(function(){p.loadGeojson(a,c,u,b,k,f,g)},500)}};this.reloadGeojson=function(a,c,k){if(m){t(!0);for(var b=y(c),l=A(a),f=l.entities.values,g=0;g<f.length;g++)f[g].polygon.material=b.fill,f[g].polygon.outlineColor=
b.outline;k&&d.viewer.zoomTo(l);t(!1)}else{var h=this;setTimeout(function(){h.reloadGeojson(a,c,k)},500)}};this.removeGeojson=function(a,c){if(m)t(!0),d.viewer.dataSources.remove(A(a),c),t(!1);else{var k=this;setTimeout(function(){k.removeGeojson(a,c)},500)}};this.loadTematismi=function(n,c){if(m){window.plani3dmodel.callback3d=n;if(z){$("#"+a.target+" #"+a.target+"-legend-panel").remove();$("#"+a.target+" #"+a.target+"-legend-panel-opener").remove();for(var k=0;k<d.viewer.dataSources.length;k++){var b=
d.viewer.dataSources.get(k);d.viewer.dataSources.remove(b,destroy)}}$("#"+a.target+" .cesium-viewer").append($("\x3cdiv\x3e").attr("id",a.target+"-legend-panel").attr("class","p3d-legend-panel"));$("#"+a.target+"-legend-panel").append($("\x3cdiv\x3e").attr("id",a.target+"-legend-panel-icon").attr("class","p3d-legend-panel-icon").append($("\x3ca\x3e").attr("id",a.target+"-legend-panel-closer").attr("class","p3d-legend-panel-closer").append($("\x3cimg\x3e").attr("src",a.imgpath+"imgs/layer-switcher-minimize.png"))));
$("#"+a.target+"-legend-panel-closer").click(E);$("#"+a.target+"-legend-panel").hide();$("#"+a.target+" .cesium-viewer").append($("\x3cdiv\x3e").attr("id",a.target+"-legend-panel-opener").attr("class","p3d-legend-panel-opener"));$("#"+a.target+"-legend-panel-opener").append($("\x3ca\x3e").append($("\x3cimg\x3e").attr("src",a.imgpath+"imgs/layer-switcher-maximize.png")));$("#"+a.target+"-legend-panel-opener a").click(B);$("#"+a.target+"-legend-panel-opener").hide();this.processTematismo(n,c)}else{var l=
this;setTimeout(function(){l.loadTematismi(n,c)},500)}};this.reloadTematismi=function(a,c){z=!0;this.loadTematismi(a,c)};var w=null;this.processTematismo=function(n,c){var u=this;if(m){t(!0);if(null==c||0==c.length)alert("Nessuna informazione disponibile"),$.unblockUI();else{s=c.items;w=c;F(c.themes,!1,u);B();$.unblockUI();var b=c.themes[0].title,l;for(l in s){for(var f=s[l],g=f.valori_tema[b],h,p=0;p<r[b].length;p++){var e=r[b][p];if("undefined"!=typeof e.value&&e.value==g||"undefined"!=typeof e.from&&
k.isNumeric(e.from)&&"undefined"!=typeof e.to&&k.isNumeric(e.to)&&parseFloat(e.from)<=parseFloat(g)&&parseFloat(e.to)>=parseFloat(g)){h=q[b+e.label];break}else"undefined"==typeof e.from||"undefined"==typeof e.to||k.isNumeric(e.from)&&k.isNumeric(e.to)||console.log("Attenzione, impossibile caricare il tematismo perchè non in formato numerico. Controllare i range di valori")}"undefined"==typeof f.subalterno?(console.log("carico "+f.comune+"_"+f.foglio+"_"+f.mappale),$.ajax({type:"GET",url:k.getServerUrl(a.protocol,
a.server,a.webapp)+"/rest-plani3d/list/"+f.comune+"/"+f.foglio+"/"+f.mappale+"?profile\x3dATC",dataType:d.strJsonDataType,async:!1,context:this,success:function(b){this.loadGeojson(b.name,k.getServerUrl(a.protocol,a.server,a.webapp)+"/rest-plani3d/geojson/"+b.url+"?profile\x3dATC",b.offset,b.height,"#"+h,!0,f)},error:function(a){0==a.status?$.blockUI({message:"Un ad-blocker impedisce il corretto funzionamento della pagina.\x3cbr\x3eDisabilita ad-blocker per continuare!",timeout:1E4}):$.blockUI({message:"Problema nel caricamento della configurazione di sistema",
timeout:2E3});t(!1)}})):(console.log("carico "+f.comune+"_"+f.foglio+"_"+f.mappale+"_"+f.subalterno+"_"+f.data),$.ajax({type:"GET",url:k.getServerUrl(a.protocol,a.server,a.webapp)+"/rest-plani3d/list/"+f.comune+"/"+f.foglio+"/"+f.mappale+"/"+f.subalterno+"/"+f.data+"?profile\x3dATC",dataType:d.strJsonDataType,async:!1,context:this,success:function(b){for(var c in b){var n=b[c];this.loadGeojson(n.name,k.getServerUrl(a.protocol,a.server,a.webapp)+"/rest-plani3d/geojson/"+n.url+"?profile\x3dATC",n.offset,
n.height,"#"+h,!1,f)}},error:function(a){0==a.status?$.blockUI({message:"Un ad-blocker impedisce il corretto funzionamento della pagina.\x3cbr\x3eDisabilita ad-blocker per continuare!",timeout:1E4}):$.blockUI({message:"Problema nel caricamento della configurazione di sistema",timeout:2E3});t(!1)}}))}b=$("input[name\x3dradio_tematismi]:checked").attr("id");$("#show-all"+b.substring(6)).removeAttr("class","disabled");$("#hide-all"+b.substring(6)).removeAttr("class","disabled")}t(!1)}else setTimeout(function(){u.processTematismo(n,
c)},500)};var C=function(n){$("input[type\x3dcheckbox]",$(n.data.div_id)).each(function(){"p3d-check-tematismo"!=$(this)[0].className&&$(this).prop("disabled",!$((n.data.multi?"#check_":"#radio_")+n.data.id).is(":checked"))});if($((n.data.multi?"#check_":"#radio_")+n.data.id).is(":checked")){$("#"+a.target+" #show-all"+n.data.id).removeAttr("class","disabled");$("#"+a.target+" #hide-all"+n.data.id).removeAttr("class","disabled");for(var c=0;c<themes.themes.length;c++){var d=themes.themes[c].title,
b=themes.themes[c].values;if(n.data.id!="tematismo_"+d)for($("#show-alltematismo_"+d).prop("class","disabled"),$("#hide-alltematismo_"+d).prop("class","disabled"),d=0;d<b.length;d++)$("#check_"+c+"_"+d).prop("disabled",!0)}}else $("#"+a.target+" #show-all"+n.data.id).prop("class","disabled"),$("#"+a.target+" #hide-all"+n.data.id).prop("class","disabled");n.data.multi?drawAndOr(w):(console.log("cambio tematismo: "+n.data.tematismo),G(n.data.tematismo,n.data.mythis))},G=function(a,c){for(var e in s){for(var b=
s[e],l=b.valori_tema[a],f,g=0;g<r[a].length;g++){var h=r[a][g];if("undefined"!=typeof h.value&&h.value==l||"undefined"!=typeof h.from&&k.isNumeric(h.from)&&"undefined"!=typeof h.to&&k.isNumeric(h.to)&&parseFloat(h.from)<=parseFloat(l)&&parseFloat(h.to)>=parseFloat(l)){f=q[a+h.label];break}else"undefined"==typeof h.from||"undefined"==typeof h.to||k.isNumeric(h.from)&&k.isNumeric(h.to)||console.log("Attenzione, impossibile caricare il tematismo perchè non in formato numerico. Controllare i range di valori")}if("undefined"==
typeof b.subalterno)console.log("ricarico "+b.comune+"_"+b.foglio+"_"+b.mappale),c.reloadGeojson(b.comune+"_"+b.foglio+"_"+b.mappale,"#"+f,!1);else for(console.log("ricarico "+b.comune+"_"+b.foglio+"_"+b.mappale+"_"+b.subalterno+"_"+b.data),g=0;g<d.viewer.dataSources.length;g++)l=d.viewer.dataSources.get(g),l.name.startsWithIgnorCase(b.comune+"_"+b.foglio+"_"+b.mappale+"_"+b.subalterno+"_"+b.data)&&c.reloadGeojson(l.name,"#"+f,!1)}},D=function(a){var c=a.data.div_id;"show"==a.data.op?$("input",$(c).parent()).each(function(){"p3d-check-tematismo"!=
$(this)[0].className&&$(this).prop("checked",!0)}):$("input",$(c).parent()).each(function(){"p3d-check-tematismo"!=$(this)[0].className&&$(this).prop("checked",!1)});if(a.data.multi)drawAndOr(w);else for(var e in a.data.parameters)for(var c=a.data.parameters[e].value,b=a.data.parameters[e].from,l=a.data.parameters[e].to,f=0;f<d.viewer.dataSources.length;f++){var g=d.viewer.dataSources.get(f);if("undefined"!=typeof c&&c==g.data.valori_tema[a.data.tematismo]||"undefined"!=typeof b&&k.isNumeric(b)&&
"undefined"!=typeof l&&k.isNumeric(l)&&parseFloat(b)<=parseFloat(g.data.valori_tema[a.data.tematismo])&&parseFloat(l)>=parseFloat(g.data.valori_tema[a.data.tematismo]))g.show="show"==a.data.op?!0:!1}},H=function(a){var c=a.data.check_id.substring(7);c.substr(0,c.indexOf("_"));c=c.substr(c.indexOf("_")+1);if(a.data.multi)drawAndOr(w);else for(var e=a.data.parameters.value,b=a.data.parameters.from,l=a.data.parameters.to,f=0;f<d.viewer.dataSources.length;f++){var g=d.viewer.dataSources.get(f);if("undefined"!=
typeof e&&e==g.data.valori_tema[a.data.tematismo]||"undefined"!=typeof b&&k.isNumeric(b)&&"undefined"!=typeof l&&k.isNumeric(l)&&parseFloat(b)<=parseFloat(g.data.valori_tema[a.data.tematismo])&&parseFloat(l)>=parseFloat(g.data.valori_tema[a.data.tematismo]))if($(a.data.check_id).is(":checked")){g.show=!0;for(var h=0;h<themes.themes.length;h++){var p=themes.themes[h].title,m=themes.themes[h].values;if(a.data.id!="tematismo_"+p)$("#check_"+h+"_"+c).prop("checked",!0);else for(p=g.entities.values,m=
y(m[c].color),f=0;f<p.length;f++)p[f].polygon.material=m.fill,p[f].polygon.outlineColor=m.outline}}else for(g.show=!1,h=0;h<themes.themes.length;h++)p=themes.themes[h].title,a.data.id!="tematismo_"+p&&$("#check_"+h+"_"+c).prop("checked",!1)}},F=function(e,c,k){$("#"+a.target+"-legend-panel").append($("\x3cdiv\x3e").attr("id","legend-items-container"));for(var b in e){var l=e[b].title,f=e[b].values,g=l.alyLatinize().replaceAll(" ","-").replaceAll(" ","-").replaceAll("\x26nbsp;","y").replaceAll(".",
"").replaceAll(":",""),h="tematismo_"+g;$("#legend-items-container").append($("\x3cdiv\x3e").attr("id","legend-item_"+b));$("#legend-item_"+b).append($("\x3cdiv\x3e").attr("id","openclose_"+b).attr("style","display:inline"));c?($("#legend-item_"+b).append($("\x3cinput\x3e").attr("id","check_"+h).attr("level","first").attr("type","checkbox").attr("class","p3d-check-tematismo").prop("checked",!1)),$("#check_"+h).change({id:h,tematismo:l,div_id:"#legend-item_"+b,multi:c,mythis:k},C)):($("#legend-item_"+
b).append($("\x3cinput\x3e").attr("id","radio_"+h).attr("name","radio_tematismi").attr("level","first").attr("type","radio").attr("class","p3d-check-tematismo").prop("checked",0==b)),$("#radio_"+h).change({id:h,tematismo:l,div_id:"#legend-item_"+b,multi:c,mythis:k},C));$("#legend-item_"+b).append($("\x3cspan\x3e").text(g));$("#openclose_"+b).append($("\x3cinput\x3e").attr("id","legend-item_"+b+"_open").attr("type","button").attr("class","openclose myopen").click({key:b},function(a){$("#legend-item_"+
a.data.key+"_content").show();$("#legend-item_"+a.data.key+"_open").hide();$("#legend-item_"+a.data.key+"_close").show()}));$("#openclose_"+b).append($("\x3cinput\x3e").attr("id","legend-item_"+b+"_close").attr("type","button").attr("class","openclose myclose").click({key:b},function(a){$("#legend-item_"+a.data.key+"_content").hide();$("#legend-item_"+a.data.key+"_open").show();$("#legend-item_"+a.data.key+"_close").hide()}));$("#legend-item_"+b).append($("\x3cdiv\x3e").attr("id","legend-item_"+b+
"_content"));$("#legend-item_"+b+"_content").append($("\x3cdiv\x3e").attr("id","all-none-div_"+h));$("#legend-item_"+b+"_content").hide();$("#legend-item_"+b+"_close").hide();$("#all-none-div_"+h).attr("style","margin-left: 15px;").append($("\x3ca\x3e").prop("disabled",!0).attr("id","show-all"+h).attr("class","disabled").text("Mostra tutti").click({id:h,viewer:d.viewer,div_id:"#legend-item_"+b,tematismo:l,op:"show",parameters:e[b].values,multi:c},D)).append($("\x3cspan\x3e").text(" / ")).append($("\x3ca\x3e").prop("disabled",
!0).attr("id","hide-all"+h).attr("class","disabled").text("Nascondi tutti").click({id:h,viewer:d.viewer,div_id:"#legend-item_"+b,tematismo:l,op:"hide",parameters:e[b].values,multi:c},D));for(g=0;g<f.length;g++)$("#legend-item_"+b+"_content").append($("\x3cdiv\x3e").attr("id","legend-item-value_"+b+"_"+g)),$("#legend-item-value_"+b+"_"+g).append($("\x3cinput\x3e").attr("id","check_"+b+"_"+g).attr("level","second").attr("parent",h).attr("index",g).attr("type","checkbox").attr("style","margin-left: 20px; vertical-align: top;").prop("checked",
!c).prop("disabled",0!=b)),c||$("#legend-item-value_"+b+"_"+g).append($("\x3cdiv\x3e").attr("class","p3d-circle").attr("style","background: #"+f[g].color)),$("#check_"+b+"_"+g).change({check_id:"#check_"+b+"_"+g,id:h,tematismo:l,viewer:d.viewer,parameters:e[b].values[g],multi:c},H),f[g].label=f[g].label.replace("@from@",f[g].from).replace("@to@",f[g].to),$("#legend-item-value_"+b+"_"+g).append($("\x3cdiv\x3e").attr("style","display: inline-block; width: 200px; padding-left: 5px;").text(f[g].label));
r[l]=e[b].values;for(f=0;f<r[l].length;f++)h=r[l][f],"undefined"==typeof q[l+h.label]&&null!=h.color&&(q[l+h.label]=h.color)}},y=function(a){a.startsWith("#")||(a="#"+a);var c=Cesium.Color.fromCssColorString(a);a=new Cesium.Color(c.red,c.green,c.blue,.5);c=new Cesium.Color(c.red,c.green,c.blue,1);return{fill:a,outline:c}},A=function(a){for(var c=0;c<d.viewer.dataSources.length;c++){var e=d.viewer.dataSources.get(c);if(e.name.startsWithIgnorCase(a))return e}},B=function(){$("#"+a.target+" #"+a.target+
"-legend-panel").show();$("#"+a.target+" #"+a.target+"-legend-panel-opener").hide();$("#"+a.target+" #search-results-panel").is(":visible")&&this.closeResults()},E=function(){$("#"+a.target+" #"+a.target+"-legend-panel").hide();$("#"+a.target+" #"+a.target+"-legend-panel-opener").show()},x=0,t=function(d){d?($("#"+a.target+" #myprogress").fadeIn(200),x++):0<x&&x--;0==x&&$("#"+a.target+" #myprogress").fadeOut(200)}};
//# sourceMappingURL=plani3d-3d.min.js.map