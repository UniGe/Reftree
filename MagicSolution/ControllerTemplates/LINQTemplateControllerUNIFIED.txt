using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Http;
using System.Net;
using System.Net.Http;
using AttributeRouting.Web.Http;
using System.Linq.Dynamic;
using System.Configuration;
using System.Reflection;


namespace {1}.Controllers
{{
    public class {0}Controller :ApiController
    {{

      
      // the linq to sql context that provides the data access layer
      private {2}.{3} _context = new {2}.{3}();
	  static string groupVisibilityField = ApplicationSettingsManager.GetVisibilityField();
	  PropertyInfo propertyInfo = typeof(Models.{0}).GetProperty(groupVisibilityField); 
      
      //get all elements of an entity
	[HttpGet]
        public List<Models.{0}> GetAll()
        {{
			string wherecondition = "1=1";

			if (propertyInfo != null){{
			    wherecondition = MagicFramework.UserVisibility.UserVisibiltyInfo.getWhereCondition("{0}", wherecondition);
			}}


			// select from the database, skipping and taking the correct amount
			var resdb = (from e in _context.{5}
							.Where(wherecondition)
							select new Models.{0}(e)).ToList();
							  
            return resdb;  
  
        }}
	
	//get a single object 
	[HttpGet]
        public List<Models.{0}> Get({6} id)
        {{
            var resobj = (from e in _context.{5}.Where(x=> x.{4} == id)
                          select new Models.{0}(e)).ToList();
            return resobj;
        }}


        //The grid will call this method in read mode
     
      [HttpPost]
      public MagicFramework.Models.Response Select(MagicFramework.Models.Request request)
      {{
			  
			  MagicFramework.Helpers.RequestParser rp = new MagicFramework.Helpers.RequestParser(request);
			  string order = "{4}";
			  String wherecondition = "1=1";
			  

				if (propertyInfo != null){{
				    if (request.filter!=null){{
						wherecondition = rp.BuildWhereCondition(typeof({2}.{0}));
					}}
					wherecondition = MagicFramework.UserVisibility.UserVisibiltyInfo.getWhereCondition("{0}", wherecondition);
				}}
				else{{
					if (request.filter!=null){{
						wherecondition = rp.BuildWhereCondition(typeof(Models.{0}));
					}}
				}}
	  
			  if (request.sort != null && request.sort.Count > 0)
				  order = rp.BuildOrderCondition();
       
			  var dbres= (from e in _context.{5}
												.Where(wherecondition)
												.OrderBy(order.ToString())
												.Skip(request.skip)
												.Take(request.take)                                            
								select new Models.{0}(e)).ToArray(); 

			  return new MagicFramework.Models.Response(dbres, _context.{5}.Where(wherecondition).Count());
		   }}

          //The grid will call this method in update mode
      [HttpPost]
      public HttpResponseMessage PostU({6} id,dynamic data)
      {{         
		       // create a response message to send back
               var response = new HttpResponseMessage();
        
                try
              {{
                  // select the item from the database where the id
                  
                  var entityupdate = (from e in _context.{5}
                                      where e.{4} == id
                                      select e).FirstOrDefault();
                  
                  if (entityupdate != null)
                  {{
					 _context.ServerSideCheck("{0}", MagicFramework.Helpers.SessionHandler.UserCulture, data.ToString().Replace("'", "''"), "UPDATE",MagicFramework.Helpers.SessionHandler.UserVisibilityGroup);
					 if (propertyInfo != null) {{
						var updID =  _context.ExecuteJSONCRUD(data.ToString().Replace("'", "''"), id, "UPDATE", MagicFramework.Helpers.SessionHandler.UserVisibilityGroup, "{0}",true);
					 }}
					 else{{
						var updID =  _context.ExecuteJSONCRUD(data.ToString().Replace("'", "''"), id, "UPDATE", MagicFramework.Helpers.SessionHandler.UserVisibilityGroup, "{0}",false);
					 }}
                     response.StatusCode = HttpStatusCode.OK;
                  }}
                  else
                  {{
                      response.StatusCode = HttpStatusCode.InternalServerError;
                      response.Content = new StringContent(string.Format("The item with id {{0}} was not found in the database", id.ToString()));
                  }}
              }}
              catch (Exception ex)
              {{
                   response.StatusCode = HttpStatusCode.InternalServerError;
                  response.Content = new StringContent(string.Format("The database updated failed: {{0}}", ex.Message));
              }}

			// return the HTTP Response.
			return response;
		  }}


      //The grid will call this method in insert mode
   
      [HttpPost]
      public MagicFramework.Models.Response PostI(dynamic data)
      {{

			try
			  {{
					  _context.ServerSideCheck("{0}", MagicFramework.Helpers.SessionHandler.UserCulture, data.ToString().Replace("'", "''"), "INSERT",MagicFramework.Helpers.SessionHandler.UserVisibilityGroup);
					  int id = -1;
					  int inserted = -1;

					  if (propertyInfo != null) {{
						var insID = _context.ExecuteJSONCRUD(data.ToString().Replace("'", "''"), id, "INSERT", MagicFramework.Helpers.SessionHandler.UserVisibilityGroup, "{0}",true);
						foreach (var item in insID)
					    {{
							inserted = int.Parse(item.modID.ToString());
					    }}
					  }}
					  else{{
						var insID = _context.ExecuteJSONCRUD(data.ToString().Replace("'", "''"), id, "INSERT", MagicFramework.Helpers.SessionHandler.UserVisibilityGroup, "{0}",false);
						foreach (var item in insID)
					    {{
							inserted = int.Parse(item.modID.ToString());
					    }}
					  }}
  
					  var dbres  = (from e in _context.{5}
													   .Where("{4} == "+ inserted.ToString())
									 select new Models.{0}(e)).ToArray();  
        
      
			return new MagicFramework.Models.Response(dbres, dbres.Length);
			}}
			catch (Exception ex) {{
						return new MagicFramework.Models.Response(ex.Message);
			}}
	 }}
		
     
       [HttpPost]
      public HttpResponseMessage PostD({6} id)
      {{
          // create a response message to send back
          var response = new HttpResponseMessage();

          try
          {{
              // select the item from the database where the id

              var entitytodestroy = (from e in _context.{5}
                                     where e.{4} == id
                                     select e).FirstOrDefault();

              if (entitytodestroy != null)
              {{
                  _context.{5}.DeleteOnSubmit(entitytodestroy);
                  _context.SubmitChanges();
                  response.StatusCode = HttpStatusCode.OK;
              }}
              else
              {{
                  response.StatusCode = HttpStatusCode.InternalServerError;
                  response.Content = new StringContent(string.Format("The item with id {{0}} in {5} was not found in the database", id.ToString()));
              }}
          }}
          catch (Exception ex)
          {{
              response.StatusCode = HttpStatusCode.InternalServerError;
              response.Content = new StringContent(string.Format("{5}:The database delete failed with message -{{0}}", ex.Message));
          }}

          // return the HTTP Response.
          return response;
      }}
	}}
}}