using System;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Http;
using System.Net;
using System.Net.Http;
using AttributeRouting.Web.Http;
using System.Linq.Dynamic;
using System.Configuration;
using MagicFramework;
using MagicFramework.Helpers;
using System.IO;
using System.Reflection;
using System.Data.SqlClient;
using System.Data;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using System.Web.Script.Serialization;

namespace {1}.Controllers
{{
    public class {0}Controller :ApiController
    {{  
	 
      // the linq to sql context that provides the data access layer	  
      private {2}.{3} _context = DBConnectionManager.GetEFManagerConnection() != null ? new {2}.{3}(DBConnectionManager.GetEFManagerConnection()) : new {2}.{3}();
	  static string groupVisibilityField = ApplicationSettingsManager.GetVisibilityField().ToUpper();
	  PropertyInfo propertyInfo = typeof({2}.{0}).GetProperty(groupVisibilityField); 
      

     //get all elements of an entity
	 [HttpGet]
     public List<{2}.{0}> GetAll()
     {{
         string wherecondition = "1=1";

		 if (propertyInfo != null){{
		  	 wherecondition = MagicFramework.UserVisibility.UserVisibiltyInfo.getWhereCondition("{0}", wherecondition);
		 }}

		 // select from the database, skipping and taking the correct amount
		 var resdb = (from e in _context.{5}
						.Where(wherecondition)
						select e).ToList();

		return resdb;
     }}
	

	//get a single object 
	[HttpGet]
        public List<{2}.{0}> Get({6} id)
        {{
            var resobj = (from e in _context.{5}.Where(x=> x.{4} == id)
                          select e).ToList();
            return resobj;
        }}


      //The grid will call this method in read mode
     [HttpPost]
      public MagicFramework.Models.Response Select(MagicFramework.Models.Request request)
      {{
          MagicFramework.Helpers.RequestParser rp = new MagicFramework.Helpers.RequestParser(request);
          string order = "{4}";
          String wherecondition = "1=1";
          if (request.filter!=null)
              wherecondition = rp.BuildWhereCondition(typeof({2}.{0}));
		  if (request.sort != null && request.sort.Count > 0)
			  order = rp.BuildOrderCondition();

		  if (propertyInfo != null){{
			  wherecondition = MagicFramework.UserVisibility.UserVisibiltyInfo.getWhereCondition("{0}", wherecondition);
		  }}
		  
           var dbres= (from e in _context.{5}
							.Where(wherecondition)
							.OrderBy(order.ToString())
							.Skip(request.skip)
							.Take(request.take)                                            
                       select e).ToArray();  
		   
           return new MagicFramework.Models.Response(dbres, _context.{5}.Where(wherecondition).Count());
      }}


      //The grid will call this method in update mode
      [HttpPost]
      public HttpResponseMessage PostU({6} id,dynamic data)
      {{         
          // create a response message to send back
          var response = new HttpResponseMessage();
        
            try
            {{

			// call SP with EF (need to import SP in context, generate function and call it here)
			//using ({2}.{3} ctx = new {2}.{3}())
            //{{
            //    ctx.ServerSideCheck("{5}", MagicFramework.Helpers.SessionHandler.UserCulture, data.ToString().Replace("'", "''"), "UPDATE", MagicFramework.Helpers.SessionHandler.UserVisibilityGroup);
            //}}


			  //Deserialize the JSON (string) into an object
				System.Web.Script.Serialization.JavaScriptSerializer jss = new System.Web.Script.Serialization.JavaScriptSerializer();
				  {2}.{0} inputdata = jss.Deserialize<{2}.{0}>(data.ToString());
                  // select the item from the database where the id
                  var entityupdate = (from e in _context.{5}
                                      where e.{4} == id
                                      select e).FirstOrDefault();
                  
                  if (entityupdate != null)
                  {{
					foreach (PropertyInfo f in typeof({2}.{0}).GetProperties())
					{{
							entityupdate.GetType().GetProperty(f.Name).SetValue(entityupdate, inputdata.GetType().GetProperty(f.Name).GetValue(inputdata));
				    }}

					// put your business logic here

					_context.SaveChanges();
                  }}
                  else
                  {{
                      response.StatusCode = HttpStatusCode.InternalServerError;
                      response.Content = new StringContent(string.Format("The item with id {{0}} was not found in the database", id.ToString()));
                  }}
              }}
              catch (Exception ex)
              {{
				 if (ex.InnerException.InnerException != null)
				  {{
					 MagicFramework.Helpers.MFLog.LogInFile(ex.InnerException.InnerException.Message, MFLog.logtypes.ERROR);
				  }}
                  response.StatusCode = HttpStatusCode.InternalServerError;
                  response.Content = new StringContent(string.Format("The database updated failed: {{0}}", ex.Message));
              }}
       
          // return the HTTP Response.
          return response;
      }}


      //The grid will call this method in insert mode
      [HttpPost]
      public MagicFramework.Models.Response PostI(dynamic data)
      {{
           try
          {{
				System.Web.Script.Serialization.JavaScriptSerializer jss = new System.Web.Script.Serialization.JavaScriptSerializer();
				{2}.{0} inputdata = jss.Deserialize<{2}.{0}>(data.ToString());
               
				// call SP with EF (need to import SP in context, generate function and call it here)
				// using ({2}.{3} ctx = new {2}.{3}())
				// {{
				//	ctx.ServerSideCheck("{5}", MagicFramework.Helpers.SessionHandler.UserCulture, data.ToString().Replace("'", "''"), "INSERT", MagicFramework.Helpers.SessionHandler.UserVisibilityGroup);
				// }}
				  
				{2}.{0} datatoinsert = new {2}.{0}();
				foreach (PropertyInfo f in typeof({2}.{0}).GetProperties())
				{{
						datatoinsert.GetType().GetProperty(f.Name).SetValue(datatoinsert, inputdata.GetType().GetProperty(f.Name).GetValue(inputdata));
				}}
				_context.{5}.Add(datatoinsert);
				_context.SaveChanges();
				{6} id = datatoinsert.{4};		
                var dbres  = (from e in _context.{5}
                                                .Where("{4} == "+ id.ToString())
                                select e).ToArray();  
        
      
        return new MagicFramework.Models.Response(dbres, dbres.Length);
		}}
		catch (Exception ex) {{
				  if (ex.InnerException.InnerException != null)
				  {{
					 MagicFramework.Helpers.MFLog.LogInFile(ex.InnerException.InnerException.Message, MFLog.logtypes.ERROR);
				  }}
					return new MagicFramework.Models.Response(ex.Message);
		}}
      }}
     

      [HttpPost]
      public HttpResponseMessage PostD({6} id)
      {{
          // create a response message to send back
          var response = new HttpResponseMessage();
          try
          {{
              // select the item from the database where the id
              var entitytodestroy = (from e in _context.{5}
                                     where e.{4} == id
                                     select e).FirstOrDefault();
              if (entitytodestroy != null)
              {{
                  _context.{5}.Remove(entitytodestroy);
                  _context.SaveChanges();
                  response.StatusCode = HttpStatusCode.OK;
              }}
              else
              {{
                  response.StatusCode = HttpStatusCode.InternalServerError;
                  response.Content = new StringContent(string.Format("The item with id {{0}} in {5} was not found in the database", id.ToString()));
              }}
          }}
          catch (Exception ex)
          {{
              response.StatusCode = HttpStatusCode.InternalServerError;
              response.Content = new StringContent(string.Format("{5}:The database delete failed with message -{{0}}", ex.Message));
          }}
          // return the HTTP Response.
          return response;
      }}        
    }}
}}