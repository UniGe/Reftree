using MagicFramework.Helpers;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net;
using System.Net.Http;
using System.Net.Mime;
using System.Web;
using System.Web.Http;

namespace MagicFramework.Controllers
{
    public class GridProxyController : ApiController
    {
        /* How to config girds, dropdowns and autocompletes to use custom endpoints (In MagicFramework there is a grid called Table_MOCK_DATA that uses this settings)
         * 
         * Grids:
         * Go to the function Grids: Open the navigation of the grid you want to change, go to the tag "Datasources" and edit the datasource. Change the "url" property to point to your controller:
         * { url: "/api/ExampleGridProxy/Select", type: "POST", contentType: "application/json" }
         * 
         * Autocompletes and Dropdowns:
         * As you did before open the navigation of the grid, this time go to "Base properties"
         * Open the navigation of the column you want to use a custom controller and click on the first tab "Template behaviour" (or similar) and click on edit of the first record. Go to the tab
         * "Data source management" and set "Tipe of datasource" to "WEB API Controller", in the field below "Datasource" paste the following:
         * Create a string of the following format: "POST ExampleControllerName/ExampleControllerMethodName Tablename" encode this using base64 (btoa(yourString) in JS) then remove
         * all the "=" that may be added at the end of the string and prefix the wohle string with "base64". Paste the base64 encoded string in the field and save.
         * Example string: "base64UE9TVCBFeGFtcGxlR3JpZFByb3h5L0Ryb3Bkb3duVmFsdWVzIFRhYmxlX2ZpbGV1cGxfcHJvdmFfYW5hZ3Jh"
         */


        // called by grids and autocompletes
        // json body
        // {"take":25,"skip":0,"page":1,"pageSize":25,"filter":{"logic":"and","filters":[{"field":"id","operator":"gt","value":1,"type":"defaultFilter"}]},"childGridsData":{ },"layerID":0,"GridName":"Table_fileupl_prova","EntityName":"CUSTOM.Table_fileupl_prova","functionID":7080,"operation":"read","Model":"[{\"id\":\"id\",\"fields\":{\"id\":{\"editable\":false,\"type\":\"number\",\"databasetype\":\"int\",\"dataRole\":\"number\",\"filter\":false},\"single_file\":{\"editable\":true,\"type\":\"string\",\"databasetype\":\"nvarchar\",\"dataRole\":\"applicationupload\",\"uploadInfo\":{\"savePath\":\"\",\"fileExtensions\":\".jpg,.png,.jpeg,.gif,.iso,.pdf,.p7m\",\"isMulti\":null,\"adminUpload\":false},\"validation\":{\"maxlength\":0,\"required\":true}},\"multi_file\":{\"editable\":true,\"type\":\"string\",\"databasetype\":\"nvarchar\",\"dataRole\":\"applicationupload\",\"uploadInfo\":{\"savePath\":\"/sepp/test/du/amol/soule\",\"fileExtensions\":\"\",\"isMulti\":true,\"adminUpload\":false},\"validation\":{\"maxlength\":0,\"required\":true}},\"date_time\":{\"editable\":true,\"type\":\"date\",\"databasetype\":\"datetime\",\"dataRole\":\"datetimepicker\",\"validation\":{\"required\":true},\"defaultValue\":null},\"xml\":{\"editable\":true,\"type\":\"string\",\"databasetype\":\"xml\",\"dataRole\":\"text\",\"validation\":{\"maxlength\":1000,\"required\":true}},\"provaanagraid\":{\"editable\":true,\"type\":\"number\",\"databasetype\":\"int\",\"dataRole\":\"searchgrid_autocomplete\",\"dataSourceInfo\":{\"dsValueField\":\"ID\",\"dsTextField\":\"DESCR\",\"dataSource\":\"Table_fileupl_prova_anagra\",\"dsTypeId\":null,\"dsSchema\":null,\"cascadeColumn\":\"provattypeid\",\"cascadeFilterColumn\":\"TYPEID\",\"searchGridName\":\"Table_fileupl_prova_anagra\",\"searchGridColumnDesc\":\"DESCR\"},\"validation\":{\"required\":true}},\"provattypeid\":{\"editable\":true,\"type\":\"number\",\"databasetype\":\"int\",\"dataRole\":\"dropdownlist\",\"dataSourceInfo\":{\"dsValueField\":\"ID\",\"dsTextField\":\"DESCR\",\"dataSource\":\"Table_fileupl_prova_type\",\"dsTypeId\":null,\"dsSchema\":null,\"cascadeColumn\":\"cascadevalue\",\"cascadeFilterColumn\":\"cascadevalue\"},\"validation\":{\"required\":true}},\"num\":{\"editable\":true,\"type\":\"number\",\"databasetype\":\"int\",\"dataRole\":\"number\",\"validation\":{\"required\":true}},\"testo\":{\"editable\":false,\"type\":\"string\",\"databasetype\":\"nvarchar\",\"dataRole\":\"textarea\",\"validation\":{\"maxlength\":500,\"required\":true}},\"is_test\":{\"editable\":true,\"type\":\"boolean\",\"databasetype\":\"bit\",\"dataRole\":\"checkbox\",\"validation\":{\"required\":true}},\"is_a_new_test\":{\"editable\":true,\"type\":\"boolean\",\"databasetype\":\"bit\",\"dataRole\":\"checkbox\",\"validation\":{\"required\":true}},\"cascadevalue\":{\"editable\":true,\"type\":\"number\",\"databasetype\":\"int\",\"dataRole\":\"dropdownlist\",\"dataSourceInfo\":{\"dsValueField\":\"id\",\"dsTextField\":\"descr\",\"dataSource\":\"Table_fileupl_prova_cascade\",\"dsTypeId\":null,\"dsSchema\":null,\"cascadeColumn\":null,\"cascadeFilterColumn\":null},\"validation\":{\"required\":true}},\"EDITCOLUMN\":{\"editable\":true,\"type\":\"string\",\"databasetype\":\"nvarchar\",\"dataRole\":\"text\",\"validation\":{\"maxlength\":4000,\"required\":true},\"defaultValue\":\"[{ \\\"gridname\\\":\\\"TD_VI_TENOFA_L\\\" , \\\"label\\\" : \\\"TENOFA.1\\\" ,  \\\"field\\\" :\\\"aaa\\\", \\\"filter\\\":{ \\\"field\\\" : \\\"TK_TENOFF_ID\\\",\\\"operator\\\":\\\"eq\\\",\\\"value\\\" : \\\"@0\\\" } } , { \\\"gridname\\\" :\\\"TD_VI_TENOFA_L\\\" , \\\"label\\\" : \\\"TENOFA.2\\\" ,  \\\"field\\\" :\\\"aaa\\\",  \\\"filter\\\":{ \\\"field\\\" : \\\"TK_TENOFF_ID\\\",\\\"operator\\\":\\\"eq\\\",\\\"value\\\" : \\\"@0\\\" }  }]\"},\"provaanagraid_slave\":{\"editable\":true,\"databasetype\":\"int\",\"dataRole\":\"dropdownlist\",\"dataSourceInfo\":{\"dsValueField\":\"ID\",\"dsTextField\":\"DESCR\",\"dataSource\":\"Table_fileupl_prova_anagra_slave\",\"dsTypeId\":null,\"dsSchema\":null,\"cascadeColumn\":\"provaanagraid\",\"cascadeFilterColumn\":\"ANAGRA_ID\"},\"validation\":{\"required\":true}},\"longitude\":{\"editable\":true,\"type\":\"number\",\"databasetype\":\"decimal\",\"dataRole\":\"number\",\"validation\":{\"required\":true}},\"latitude\":{\"editable\":true,\"type\":\"number\",\"databasetype\":\"decimal\",\"dataRole\":\"number\",\"validation\":{\"required\":true}},\"address\":{\"editable\":true,\"type\":\"string\",\"databasetype\":\"nvarchar\",\"dataRole\":\"text\",\"validation\":{\"maxlength\":4000,\"required\":true}},\"xmlalternative\":{\"editable\":true,\"type\":\"string\",\"databasetype\":\"xml\",\"dataRole\":\"text\",\"validation\":{\"maxlength\":1,\"required\":true}},\"DESCR\":{\"editable\":true,\"type\":\"string\",\"databasetype\":\"nvarchar\",\"dataRole\":\"text\",\"validation\":{\"maxlength\":1000,\"required\":true}},\"taskId\":{\"editable\":true,\"type\":\"number\",\"databasetype\":\"int\",\"dataRole\":\"number\",\"validation\":{\"required\":true}},\"actionId\":{\"editable\":true,\"type\":\"number\",\"databasetype\":\"int\",\"dataRole\":\"dropdownlist\",\"dataSourceInfo\":{\"dsValueField\":\"ID\",\"dsTextField\":\"Description\",\"dataSource\":\"Magic_WorkflowAction\",\"dsTypeId\":null,\"dsSchema\":null,\"cascadeColumn\":null,\"cascadeFilterColumn\":null},\"validation\":{}},\"business_objects\":{\"editable\":true,\"type\":\"string\",\"databasetype\":\"nvarchar\",\"dataRole\":\"business_object_selector\",\"dataSourceInfo\":{\"dsValueField\":null,\"dsTextField\":null,\"dataSource\":null,\"dsTypeId\":null,\"dsSchema\":null,\"cascadeColumn\":\"cascadevalue\",\"cascadeFilterColumn\":null},\"validation\":{\"maxlength\":1500}},\"empty_fk_table\":{\"editable\":true,\"databasetype\":\"int\",\"dataRole\":\"dropdownlist\",\"dataSourceInfo\":{\"dsValueField\":\"ID\",\"dsTextField\":\"Description\",\"dataSource\":\"FK_Empty_FK\",\"dsTypeId\":1,\"dsSchema\":\"CUSTOM\",\"cascadeColumn\":\"multiselectfield\",\"cascadeFilterColumn\":\"MultiselectContentFK\"},\"validation\":{}},\"multiselectfield\":{\"editable\":true,\"type\":\"string\",\"databasetype\":\"nvarchar\",\"dataRole\":\"multiselect\",\"dataSourceInfo\":{\"dsValueField\":\"id\",\"dsTextField\":\"Asset\",\"dataSource\":\"Table_MOCK_DATA\",\"dsTypeId\":null,\"dsSchema\":null,\"cascadeColumn\":null,\"cascadeFilterColumn\":null},\"validation\":{\"maxlength\":1,\"required\":true}},\"filetable_files\":{\"editable\":true,\"type\":\"string\",\"databasetype\":\"nvarchar\",\"dataRole\":\"applicationupload\",\"uploadInfo\":{\"savePath\":\"\",\"fileExtensions\":\"\",\"isMulti\":null,\"adminUpload\":false},\"validation\":{\"maxlength\":0}},\"UserDefCol2\":{\"tab\":0,\"type\":\"string\",\"visibleAsColumn\":true,\"labels\":{\"it\":\"StringaDue\",\"en\":\"StringTwo\",\"de\":\"StringZwei\"},\"searchGrid\":{\"searchGridMagicGridName\":\"\",\"searchGridLabelColumn\":\"\",\"MagicDataSource\":\"\",\"MagicDataSourceValueField\":\"\",\"MagicDataSourceTextField\":\"\",\"MagicDataSourceType\":2},\"Order\":0,\"databasetype\":\"nvarchar(4000)\",\"dataRole\":\"textarea\",\"validation\":{\"required\":true},\"containerColumn\":\"xml\",\"popupHtml\":\"<div class=\\\"col-sm-4\\\"><div class=\\\"k-edit-label\\\">\\r\\n    <label for=\\\"UserDefCol2\\\">StringaDue</label>\\r\\n</div>\\r\\n<div class=\\\"k-edit-field\\\">\\r\\n    <textarea rows=\\\"5\\\" id=\\\"UserDefCol2\\\" class=\\\"k-input k-textbox\\\" style=\\\"width: 245px;\\\" name=\\\"UserDefCol2\\\" data-bind=\\\"value:UserDefCol2\\\" required iscustomerfield=true />\\r\\n</div>\\r\\n</div>\",\"isCustomUserField\":true},\"UserDefCol3\":{\"tab\":0,\"type\":\"numeric\",\"visibleAsColumn\":false,\"labels\":{\"it\":\"FK3\",\"en\":\"FK3\",\"de\":\"FK3\"},\"searchGrid\":{\"searchGridMagicGridName\":\"\",\"searchGridLabelColumn\":\"\",\"MagicDataSource\":\"\",\"MagicDataSourceValueField\":\"\",\"MagicDataSourceTextField\":\"\",\"MagicDataSourceType\":2},\"Order\":1,\"databasetype\":\"int\",\"column_format\":\"{0:n0}\",\"dataRole\":\"dropdownlist\",\"dataSourceInfo\":{\"dsValueField\":\"TABLE1\",\"dsTextField\":\"Fk_TextLabel\",\"dataSource\":\"Magic_GetUserDropDownValues\",\"dsSchema\":\"USERFIELDS\",\"dsTypeId\":1},\"containerColumn\":\"xml\",\"popupHtml\":\"<div class=\\\"col-sm-4\\\"><div class=\\\"k-edit-label\\\">\\r\\n    <label for=\\\"UserDefCol3dd\\\">FK3</label>\\r\\n</div>\\r\\n<div class=\\\"k-edit-field\\\">\\r\\n    <input id=\\\"UserDefCol3dd\\\" name=\\\"UserDefCol3\\\" data-select=\\\"onSelectdropDownManageNotAssignedInModel\\\" data-bind=\\\"value:UserDefCol3\\\"  data-option-label=\\\"N/A\\\" data-value-field=\\\"TABLE1\\\" data-text-field=\\\"Fk_TextLabel\\\" data-source=\\\"Magic_GetUserDropDownValues\\\" data-role=\\\"dropdownlist\\\"  iscustomerfield=true data-format=\\\"n0\\\" data-value-primitive=\\\"true\\\" />\\r\\n</div>\\r\\n</div>\",\"isCustomUserField\":true},\"unverofalso\":{\"tab\":2,\"type\":\"boolean\",\"visibleAsColumn\":true,\"labels\":{\"it\":\"un vero falso\",\"en\":\"un vero falso\",\"de\":\"un vero falso\"},\"searchGrid\":{\"searchGridMagicGridName\":\"\",\"searchGridLabelColumn\":\"\",\"MagicDataSource\":\"\",\"MagicDataSourceValueField\":\"\",\"MagicDataSourceTextField\":\"\",\"MagicDataSourceType\":2},\"Order\":2,\"databasetype\":\"bit\",\"dataRole\":\"checkbox\",\"containerColumn\":\"xmlalternative\",\"popupHtml\":\"<div class=\\\"col-sm-4\\\"><div class=\\\"k-edit-label\\\">\\r\\n    <label for=\\\"unverofalso\\\">un vero falso</label>\\r\\n</div>\\r\\n<div class=\\\"k-edit-field\\\">\\r\\n    <input type=\\\"checkbox\\\" id=\\\"unverofalso\\\" name=\\\"unverofalso\\\" data-bind=\\\"checked:unverofalso\\\"  iscustomerfield=true />\\r\\n</div>\\r\\n</div>\",\"column_template\":\"<input type=\\\"checkbox\\\" #= unverofalso ? \\\"checked=checked\\\" : \\\"\\\" # disabled=\\\"disabled\\\" ></input>\",\"isCustomUserField\":true},\"Uncampodata\":{\"tab\":1,\"type\":\"date\",\"visibleAsColumn\":true,\"labels\":{\"it\":\"Un campo data\",\"en\":\"Un campo data\",\"de\":\"Un campo data\"},\"searchGrid\":{\"searchGridMagicGridName\":\"\",\"searchGridLabelColumn\":\"\",\"MagicDataSource\":\"\",\"MagicDataSourceValueField\":\"\",\"MagicDataSourceTextField\":\"\",\"MagicDataSourceType\":2},\"Order\":3,\"databasetype\":\"datetime\",\"dataRole\":\"datetimepicker\",\"containerColumn\":\"xmlalternative\",\"popupHtml\":\"<div class=\\\"col-sm-4\\\"><div class=\\\"k-edit-label\\\">\\r\\n    <label for=\\\"Uncampodata\\\">Un campo data</label>\\r\\n</div>\\r\\n<!-- datepicker editor for field: \\\"Uncampodata\\\" -->\\r\\n<div class=\\\"k-edit-field\\\">\\r\\n    <input type=\\\"date\\\" name=\\\"Uncampodata\\\" id=\\\"Uncampodata\\\" data-bind=\\\"value:Uncampodata\\\" data-role=\\\"datetimepicker\\\"  iscustomerfield=true />\\r\\n</div>\\r\\n</div>\",\"column_attributes\":\"text-align:center;\",\"isCustomUserField\":true,\"defaultValue\":null},\"unmoney\":{\"tab\":0,\"type\":\"number\",\"visibleAsColumn\":true,\"labels\":{\"it\":\"money\",\"en\":\"money\",\"de\":\"money\"},\"searchGrid\":{\"searchGridMagicGridName\":\"\",\"searchGridLabelColumn\":\"\",\"MagicDataSource\":\"\",\"MagicDataSourceValueField\":\"\",\"MagicDataSourceTextField\":\"\",\"MagicDataSourceType\":2},\"Order\":4,\"databasetype\":\"money\",\"column_format\":\"{0:c2}\",\"dataRole\":\"number\",\"containerColumn\":\"xml\",\"popupHtml\":\"<div class=\\\"col-sm-4\\\"><div class=\\\"k-edit-label\\\">\\r\\n    <label for=\\\"unmoney\\\">money</label>\\r\\n</div>\\r\\n<div class=\\\"k-edit-field\\\">\\r\\n    <input name=\\\"unmoney\\\" data-bind=\\\"value:unmoney\\\" data-role=\\\"numerictextbox\\\"  iscustomerfield=true data-format=\\\"c2\\\" />\\r\\n</div>\\r\\n</div>\",\"isCustomUserField\":true},\"UserDefCol11\":{\"tab\":0,\"type\":\"number\",\"visibleAsColumn\":false,\"labels\":{\"it\":\"UserDefCol11\",\"en\":\"UserDefCol11\",\"de\":\"UserDefCol11\"},\"searchGrid\":{\"searchGridMagicGridName\":\"\",\"searchGridLabelColumn\":\"\",\"MagicDataSource\":\"\",\"MagicDataSourceValueField\":\"\",\"MagicDataSourceTextField\":\"\",\"MagicDataSourceType\":2},\"Order\":5,\"databasetype\":\"int\",\"column_format\":\"{0:n0}\",\"dataRole\":\"number\",\"validation\":{\"required\":true},\"containerColumn\":\"xml\",\"popupHtml\":\"<div class=\\\"col-sm-4\\\"><div class=\\\"k-edit-label\\\">\\r\\n    <label for=\\\"UserDefCol11\\\">UserDefCol11</label>\\r\\n</div>\\r\\n<div class=\\\"k-edit-field\\\">\\r\\n    <input name=\\\"UserDefCol11\\\" data-bind=\\\"value:UserDefCol11\\\" data-role=\\\"numerictextbox\\\" required iscustomerfield=true data-format=\\\"n0\\\" />\\r\\n</div>\\r\\n</div>\",\"isCustomUserField\":true},\"AcolorPicker\":{\"tab\":0,\"type\":\"string\",\"visibleAsColumn\":true,\"labels\":{\"it\":\"AcolorPicker\",\"en\":\"AcolorPicker\",\"de\":\"AcolorPicker\"},\"searchGrid\":{\"searchGridMagicGridName\":\"\",\"searchGridLabelColumn\":\"\",\"MagicDataSource\":\"\",\"MagicDataSourceValueField\":\"\",\"MagicDataSourceTextField\":\"\",\"MagicDataSourceType\":2},\"Order\":6,\"databasetype\":\"nvarchar(500)\",\"dataRole\":\"colorpicker\",\"containerColumn\":\"xml\",\"popupHtml\":\"<div class=\\\"col-sm-4\\\"><div class=\\\"k-edit-label\\\">\\r\\n    <label for=\\\"AcolorPicker\\\">AcolorPicker</label>\\r\\n</div>\\r\\n<div class=\\\"k-edit-field\\\">\\r\\n    <input type=\\\"color\\\" id=\\\"AcolorPicker\\\" data-role=\\\"colorpicker\\\" data-opacity=\\\"true\\\"     iscustomerfield=true     name=\\\"AcolorPicker\\\" data-bind=\\\"value:AcolorPicker\\\"  />\\r\\n</div></div>\",\"defaultValue\":\"#FFFFFF\",\"isCustomUserField\":true},\"aDevField\":{\"tab\":0,\"type\":\"number\",\"visibleAsColumn\":false,\"labels\":{\"it\":\"aDevField\",\"en\":\"aDevField\",\"de\":\"aDevField\"},\"searchGrid\":{\"searchGridMagicGridName\":\"\",\"searchGridLabelColumn\":\"\"},\"Order\":0,\"databasetype\":\"int\",\"column_format\":\"{0:n0}\",\"dataRole\":\"number\",\"containerColumn\":\"xml\",\"popupHtml\":\"<div class=\\\"col-sm-4\\\"><div class=\\\"k-edit-label\\\">\\r\\n    <label for=\\\"aDevField\\\">aDevField</label>\\r\\n</div>\\r\\n<div class=\\\"k-edit-field\\\">\\r\\n    <input name=\\\"aDevField\\\" data-bind=\\\"value:aDevField\\\" data-role=\\\"numerictextbox\\\"  iscustomerfield=true data-format=\\\"n0\\\" />\\r\\n</div>\\r\\n</div>\",\"isCustomUserField\":true},\"aSearchXML\":{\"tab\":2,\"type\":\"numeric\",\"visibleAsColumn\":false,\"labels\":{\"it\":\"ricerca\",\"en\":\"Search\",\"de\":\"Suche\"},\"searchGrid\":{\"searchGridMagicGridName\":\"Table_fileupl_prova_anagra\",\"searchGridLabelColumn\":\"DESCR\",\"MagicDataSource\":\"CUSTOM.Table_fileupl_prova_anagra\",\"MagicDataSourceValueField\":\"ID\",\"MagicDataSourceTextField\":\"DESCR\",\"MagicDataSourceType\":2},\"Order\":1,\"databasetype\":\"int\",\"column_format\":\"{0:n0}\",\"dataRole\":\"searchgrid\",\"dataSourceInfo\":{\"dsValueField\":\"ID\",\"dsTextField\":\"DESCR\",\"dataSource\":\"Table_fileupl_prova_anagra\",\"dsSchema\":\"CUSTOM\",\"dsTypeId\":2},\"containerColumn\":\"xml\",\"editable\":false,\"popupHtml\":\"<div class=\\\"col-sm-4\\\"><div class=\\\"k-edit-label\\\">\\r\\n    <label for=\\\"aSearchXML_binder\\\"><a class=\\\"searchgriddetail__\\\" onclick=\\\"selectCurrentItemFromResearchGrid('Table_fileupl_prova_anagra','aSearchXML','DESCR',this);\\\">ricerca</a></label>\\r\\n</div>\\r\\n<div class=\\\"k-edit-field\\\">\\r\\n    <span class=\\\"k-textbox k-space-right searchgrid\\\" style=\\\"position:relative !important; padding: 0 42px 0 0 !important;\\\">\\r\\n        <input id=\\\"aSearchXML_binder\\\" name=\\\"aSearchXML\\\" type=\\\"text\\\" readonly data-bind=\\\"value:DESCR\\\" placeholder=\\\"N/A\\\"  style=\\\"border: none;\\\" data-cascade-from=\\\"\\\" />\\r\\n        <a href=\\\"javascript:void(0)\\\" class=\\\"k-icon k-i-search\\\" onclick=\\\"selectItemFromResearchgrid('Table_fileupl_prova_anagra','aSearchXML','DESCR','','','',5,this);\\\">&nbsp;</a>\\r\\n        <a href=\\\"javascript:void(0)\\\" class=\\\"k-icon k-i-cancel\\\" onclick=\\\"unselectResearchgridValue('aSearchXML',this);\\\">&nbsp;</a>\\r\\n    </span>\\r\\n</div>\\r\\n<div id=\\\"Table_fileupl_prova_anagra_searchgrid\\\" class=\\\"gridItemSelector\\\"></div></div>\",\"isCustomUserField\":true},\"aDevField2\":{\"tab\":1,\"type\":\"number\",\"visibleAsColumn\":false,\"labels\":{\"it\":\"aDevField2\",\"en\":\"aDevField2\",\"de\":\"aDevField2\"},\"searchGrid\":{\"searchGridMagicGridName\":\"\",\"searchGridLabelColumn\":\"\",\"MagicDataSource\":\"\",\"MagicDataSourceValueField\":\"\",\"MagicDataSourceTextField\":\"\",\"MagicDataSourceType\":2},\"Order\":2,\"databasetype\":\"int\",\"column_format\":\"{0:n0}\",\"dataRole\":\"number\",\"containerColumn\":\"xml\",\"editable\":false,\"popupHtml\":\"<div class=\\\"col-sm-4\\\"><div class=\\\"k-edit-label\\\">\\r\\n    <label for=\\\"aDevField2\\\">aDevField2</label>\\r\\n</div>\\r\\n<div class=\\\"k-edit-field\\\">\\r\\n    <input name=\\\"aDevField2\\\" data-bind=\\\"value:aDevField2\\\" data-role=\\\"numerictextbox\\\"  iscustomerfield=true data-format=\\\"n0\\\" disabled  />\\r\\n</div>\\r\\n</div>\",\"isCustomUserField\":true}}}]","Columns":["xml","EDITCOLUMN","DESCR","taskId","actionId","empty_fk_table","single_file","business_objects","multi_file","multiselectfield","date_time","filetable_files","cascadevalue","provattypeid","xmlalternative","provaanagraid","provaanagraid_slave","num","testo","is_a_new_test","longitude","latitude","UserDefCol2","unverofalso","Uncampodata","unmoney","AcolorPicker"],"DataSourceCustomParam":"{validation:{Type:\"StoredProcedure\",DataFormat:\"XML\",Definition:\"CUSTOM.WizardConstraints_save_mock\"}, export:{Type:\"StoredProcedure\",DataFormat:\"JSON\",Definition:\"dbo.Magic_Commands_usp_exp_stmt\"},read:{Type:\"StoredProcedure\",\"Definition\":\"dbo.Magic_XMLCommands_usp_sel_stmt\"},update:{Type:\"StoredProcedure\",DataFormat:\"JSON\",Definition:\"dbo.Magic_Cmnds_ins_upd_del_stmt\"},create:{Type:\"StoredProcedure\",DataFormat:\"JSON\",Definition:\"dbo.Magic_Cmnds_ins_upd_del_stmt\"},destroy:{Type:\"StoredProcedure\",DataFormat:\"JSON\",Definition:\"dbo.Magic_Cmnds_ins_upd_del_stmt\"}}","data":"{\"user_latitude\":46.485524299999994,\"user_longitude\":11.351578199999999}","documentSearch":{ "single_file":{ "searchText":"","savePath":""},"multi_file":{ "searchText":"","savePath":"/sepp/test/du/amol/soule"} }}
        [HttpPost]
        public HttpResponseMessage Select(MagicFramework.Models.Request request)
        {
            //return new GenericSqlCommandController().Select(request);

            var externalURL = new MagicFramework.Helpers.MFConfiguration().GetApplicationInstanceByID(SessionHandler.ApplicationDomainURL, SessionHandler.ApplicationInstanceId)
                    .CustomSettings
                    .Where(s => s.Key.Equals("GridProxyControllerExternalURL"))
                    .FirstOrDefault().Value;

            var sessionPropertyToAddToAuthorizationHeader = new MagicFramework.Helpers.MFConfiguration().GetApplicationInstanceByID(SessionHandler.ApplicationDomainURL, SessionHandler.ApplicationInstanceId)
                    .CustomSettings
                    .Where(s => s.Key.Equals("GridProxyControllerAuthorizationHeaderSessionProperty"))
                    .FirstOrDefault()?.Value;

            var httpWebRequest = (HttpWebRequest)WebRequest.Create(externalURL);
            httpWebRequest.ContentType = "application/json";
            httpWebRequest.Method = "POST";
            if (!string.IsNullOrEmpty(sessionPropertyToAddToAuthorizationHeader))
            {
                httpWebRequest.Headers.Add("AUTHORIZATION", (string)HttpContext.Current.Session[sessionPropertyToAddToAuthorizationHeader]);
            }

            using (var streamWriter = new StreamWriter(httpWebRequest.GetRequestStream()))
            {
                string json = Newtonsoft.Json.JsonConvert.SerializeObject(request);
                streamWriter.Write(json);
            }

            var httpResponse = (HttpWebResponse)httpWebRequest.GetResponse();
            if (httpResponse.StatusCode == HttpStatusCode.OK)
            {
                using (var streamReader = new StreamReader(httpResponse.GetResponseStream()))
                {
                    var result = streamReader.ReadToEnd();
                    var res = new HttpResponseMessage
                    {
                        StatusCode = HttpStatusCode.OK,
                        Content = new StringContent(result),
                    };
                    res.Content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/json");
                    return res;
                }
            }
            using (var streamReader = new StreamReader(httpResponse.GetResponseStream()))
            {
                var result = streamReader.ReadToEnd();
                throw new Exception(result);
            }
        }

        [HttpPost]
        public MagicFramework.Models.Response Insert(dynamic data)
        {
            return new GenericSqlCommandController().PostI(data);
        }

        [HttpPost]
        public HttpResponseMessage Update(int id, dynamic data)
        {
            return new GenericSqlCommandController().PostU(id, data);
        }

        [HttpPost]
        public HttpResponseMessage Delete(int id, dynamic data)
        {
            return new GenericSqlCommandController().PostD(id, data);
        }

        // called by dropdowns
        // json body
        // {"schema":null,"tablename":"Table_fileupl_prova_anagra","EntityName":"null.Table_fileupl_prova_anagra","valuefield":"ID","textfield":"DESCR","filter":null,"take":1000}
        // for drops use select too
        //[HttpPost]
        //public List<ReturnFKitem> DropdownValues(dynamic data)
        //{
        //    return new ManageFKController().GetDropdownValues(data);
        //}

    }
}
